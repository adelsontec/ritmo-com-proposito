import { useState } from "react";

export default function PlanoHidratacao() {
  const [ativado, setAtivado] = useState(false);

  async function ativarPlano() {
    if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
      alert("Seu navegador nÃ£o suporta notificaÃ§Ãµes push.");
      return;
    }

    const permission = await Notification.requestPermission();
    if (permission !== "granted") {
      alert("PermissÃ£o de notificaÃ§Ã£o negada.");
      return;
    }

    const vapidKey = process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY;
    if (!vapidKey) {
      alert("Chave VAPID pÃºblica nÃ£o configurada.");
      return;
    }

    const registration = await navigator.serviceWorker.ready;

    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(vapidKey),
    });

    await fetch("/api/schedule-water-reminder", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        subscription,
        title: "ðŸ’§ Hora de beber Ã¡gua!",
        body: "Beba um copo a cada 2 horas. HÃ¡bito saudÃ¡vel, mente saudÃ¡vel!",
      }),
    });

    setAtivado(true);

    // Simula agendamento local
    setInterval(() => {
      if (Notification.permission === "granted") {
        new Notification("ðŸ’§ Hora de beber Ã¡gua!", {
          body: "Beba um copo agora para manter a hidrataÃ§Ã£o.",
        });
      }
    }, 2 * 60 * 60 * 1000); // 2 horas
  }

  return (
    <main className="max-w-2xl mx-auto p-4">
      <h1 className="text-2xl font-bold mb-4">Plano de HidrataÃ§Ã£o</h1>
      <p className="mb-4">
        Este plano irÃ¡ te lembrar a cada 2 horas para beber um copo de Ã¡gua (250ml).
      </p>
      <button
        onClick={ativarPlano}
        disabled={ativado}
        className={`px-4 py-2 rounded ${ativado ? "bg-gray-500" : "bg-blue-600 text-white"}`}
      >
        {ativado ? "Plano Ativado âœ…" : "Ativar Lembretes"}
      </button>
    </main>
  );
}

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");
  const raw = atob(base64);
  return Uint8Array.from([...raw].map((char) => char.charCodeAt(0)));
}
